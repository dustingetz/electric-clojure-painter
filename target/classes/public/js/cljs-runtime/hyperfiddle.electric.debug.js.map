{"version":3,"sources":["hyperfiddle/electric/debug.cljc"],"mappings":"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","names":["js/hyperfiddle","js/hyperfiddle.electric","js/hyperfiddle.electric.debug","js/hyperfiddle.electric.debug.PEER-ID","hyperfiddle.electric.debug/PEER-ID","cljs.core/random-uuid","hyperfiddle.electric.debug/add-stack-frame","frame","ex","cljs.core.ex_info","cljs.core/ex-message","cljs.core.update","cljs.core/ex-data","cljs.core.fnil","cljs.core/conj","cljs.core.assoc","or__5045__auto__","cljs.core/ex-cause","var_args","G__42350","hyperfiddle.electric.debug/error","js/Error","js/hyperfiddle.electric.Failure","debug-info","failure","err","js/hyperfiddle.electric.Pending","js/missionary.Cancelled","hyperfiddle.electric.debug/render-arg","arg","cljs.core/ident?","cljs.core.symbol","*print-level*-orig-val__42386","*print-length*-orig-val__42387","*print-level*-temp-val__42388","*print-length*-temp-val__42389","cljs.core/*print-level*","cljs.core/*print-length*","cljs.core.pr_str","hyperfiddle.electric.debug/serializable-frame","cljs.core.partial","cljs.core/mapv","hyperfiddle.electric.debug/serializable","map","cljs.core/contains?","hyperfiddle.electric.debug/normalize-frame","meta","dbg-in-meta","contrib.data/select-ns","cljs.core.merge","cljs.core.dissoc","hyperfiddle.electric.debug/stack-trace","G__42433","cljs.core.remove","cljs.core._EQ_","cljs.core.filter","cljs.core.reduce","r","cljs.core.conj","map__42438","cljs.core/--destructure-map","cljs.core.get","origin","type","name","params","args","macro","scope","cljs.core.into","and__5043__auto__","cljs.core.not_EQ_","cljs.core/not","fexpr__42450","G__42451","cljs.core/Keyword","G__42455","cljs.core/vec","cljs.core.sequence","cljs.core/seq","cljs.core.concat","cljs.core/List","G__42456","cljs.core.map","map__42459","action","target","method","G__42469","cljs.core/rest","cljs.core/name","G__42480","G__42483","cljs.core.mapv","clojure.string.join","cljs.core/nil?","hyperfiddle.electric.debug/unwrap","exception"],"sourcesContent":["(ns hyperfiddle.electric.debug\n  (:require #_[hyperfiddle.electric.impl.runtime :as-alias r]\n            [clojure.string :as str]\n            [contrib.data :as data]\n            [hyperfiddle.electric.impl.ir :as-alias ir])\n  (:import (hyperfiddle.electric Failure Pending)\n           (missionary Cancelled)\n           #?(:clj (clojure.lang ExceptionInfo))))\n\n(defonce ^{:doc \"A random unique ID generated for each Electric runtime instance (browser tab, jvm). Used to identify origin of a transfered value.\"}\n  PEER-ID\n  ;; UUID v4 collision probability assumed insignificant for this use case\n  #?(:clj  (java.util.UUID/randomUUID)\n     :cljs (random-uuid)))\n\n(defn add-stack-frame [frame ex] ; TODO use Throwable.setStackTrace if possible instead of allocating a new ExInfo for each frame\n  (ex-info (ex-message ex)\n    (-> (update (ex-data ex) ::trace (fnil conj []) (assoc frame ::origin PEER-ID))\n      (assoc :hyperfiddle.electric/type ::trace))\n    (or (ex-cause ex) ex)))\n\n(defn error ; TODO Don\u2019t use ExceptionInfo. It is slow because it computes the stacktrace on instantiation. We don\u2019t need it.\n  ([^ExceptionInfo ex]\n   (Failure. (ex-info (ex-message ex) (assoc (ex-data ex) :hyperfiddle.electric/type ::trace) (ex-cause ex))))\n  ([debug-info ^Failure failure]\n   (let [err (.-error failure)]\n     (if (or (instance? Pending err)\n           (instance? Cancelled err))\n       failure\n       (Failure. (add-stack-frame debug-info err))))))\n\n(defn render-arg [arg]\n  (cond\n    (string? arg) arg\n    (ident? arg)  arg\n\n    (or (instance? hyperfiddle.electric.Failure arg)\n      #?(:clj (instance? Throwable arg)\n         :cljs (instance? js/Error arg)))\n    (symbol \"<exception>\")\n\n    :else\n    (binding [*print-level*  1\n              *print-length* 4]\n      (pr-str arg))))\n\n(defn serializable-frame [frame]\n  (if (::serializable frame)\n    frame\n    (-> (update frame ::args (partial mapv render-arg))\n        (assoc ::serializable true))))\n\n(defn serializable [map]\n  (if (contains? map ::trace)\n    (update map ::trace (partial mapv serializable-frame))\n    map))\n\n(defn normalize-frame [frame]\n  (let [meta        (::meta frame)\n        dbg-in-meta (data/select-ns :hyperfiddle.electric.debug (::meta frame))]\n    (merge frame dbg-in-meta {::meta (dissoc meta dbg-in-meta)})))\n\n(defn stack-trace [err]\n  (some->> (::trace (ex-data err))\n    (remove (fn [frame] (= {} (::name frame)))) ; (do a b) => ({} a b)\n    (filter ::type)\n    (reduce (fn [r frame]\n              (if (string? frame)\n                (conj r frame)\n                (let [{::keys [origin type name params args macro scope meta]} (normalize-frame frame)]\n                  (conj r\n                    (into [(when (and (not= PEER-ID origin)\n                                   (not (#{:transfer :toggle} type))\n                                   \"remote\"))\n                           (case scope\n                             :lexical \"lexically bound\"\n                             :dynamic \"dynamically bound\"\n                             nil)]\n                      (into\n                        (case type\n                          :apply         `[\"(\" ~(case name\n                                                  hyperfiddle.electric.impl.runtime/fail 'throw\n                                                  name)\n                                           ~@(map render-arg args) \")\"]\n                          :eval (let [{::keys [action target method args]} frame]\n                                  (case action\n                                    :field-access [\"(\" (str \".-\" method) target \")\"]\n                                    :static-call  `[\"(\" ~(str target \"/\" method) ~@(map render-arg (rest args)) \")\"]\n                                    :call         `[\"(\" ~(str \".\" method) ~target ~@(map render-arg (rest args))\")\"]\n                                    :fn-call      (if (some? name)\n                                                    `[\"(\" (clojure.core/fn ~name [~@params] ~'\u2026) ~@(map render-arg args) \")\"]\n                                                    `[\"(\" (clojure.core/fn [~@params] ~'\u2026) ~@(map render-arg args) \")\"])\n\n                                    [\"<unknown interop>\" frame]))\n                          :reactive-fn   [\"reactive\" (if (some? name)\n                                                       `(~'fn ~name ~args ~'...)\n                                                       `(~'fn ~args ~'...))]\n                          :reactive-defn [\"reactive\" `(~'defn ~name ~args ~'...)]\n                          :try           [\"(try ...)\" ]\n                          :catch         [`(~'catch ~@args ~'...)]\n                          :finally       [\"(finally ...)\"]\n                          :case-clause   [`(~'case ~@args ~'...)]\n                          :case-default  [\"case default branch\"]\n                          :transfer      [\"transfer to\" (clojure.core/name name)]\n                          :toggle        [\"transfer\"]\n                          `[\"<unknow frame>\" ~(::ir/op frame)])\n                        [(when macro (str \"from macro \" macro))\n                         (some->> (:file meta) (str \"in \"))\n                         (some->> (:line meta) (str \"line \"))]))))))\n      [])\n    (mapv (fn [frame] (if (string? frame) frame (str \" in \" (str/join \" \" (remove nil? frame))))))\n    (str/join \"\\n\")))\n\n(defn unwrap [exception]\n  (if (= ::trace (:hyperfiddle.electric/type (ex-data exception)))\n    (ex-cause exception)\n    exception))\n"]}